{"version":3,"file":"edit-event.js","sources":["../../../foundation/edit-event.ts"],"sourcesContent":["/** Intent to `parent.insertBefore(node, reference)` */\nexport type Insert = {\n  parent: Node;\n  node: Node;\n  reference: Node | null;\n};\n\nexport type NamespacedAttributeValue = {\n  value: string | null;\n  namespaceURI: string | null;\n};\nexport type Value = string | null;\nexport type AttributeValue = Value | NamespacedAttributeValue;\n/**\n * Intent to set or remove (if null) attributes on element\n * @deprecated - use `UpdateNS` for updating namespaced attributes instead.\n */\nexport type Update = {\n  element: Element;\n  attributes: Partial<Record<string, AttributeValue>>;\n};\n\n/** Intent to set or remove (if null) attributes on element */\nexport type UpdateNS = {\n  element: Element;\n  attributes: Partial<Record<string, Value>>;\n  attributesNS: Partial<Record<string, Partial<Record<string, Value>>>>;\n};\n\n/** Intent to remove a node from its ownerDocument */\nexport type Remove = {\n  node: Node;\n};\n\n/** Represents the user's intent to change an XMLDocument */\nexport type Edit = Insert | Update | UpdateNS | Remove | Edit[];\n\nexport function isComplex(edit: Edit): edit is Edit[] {\n  return edit instanceof Array;\n}\n\nexport function isInsert(edit: Edit): edit is Insert {\n  return (edit as Insert).parent !== undefined;\n}\n\nexport function isNamespaced(\n  value: AttributeValue\n): value is NamespacedAttributeValue {\n  return value !== null && typeof value !== 'string';\n}\n\nexport function isUpdate(edit: Edit): edit is Update {\n  return 'element' in edit && !('attributesNS' in edit);\n}\n\nexport function isUpdateNS(edit: Edit): edit is UpdateNS {\n  return 'element' in edit && 'attributesNS' in edit;\n}\n\nexport function isRemove(edit: Edit): edit is Remove {\n  return (\n    (edit as Insert).parent === undefined && (edit as Remove).node !== undefined\n  );\n}\n\nexport type EditEvent<E extends Edit = Edit> = CustomEvent<E>;\n\nexport function newEditEvent<E extends Edit>(edit: E): EditEvent<E> {\n  return new CustomEvent<E>('oscd-edit', {\n    composed: true,\n    bubbles: true,\n    detail: edit,\n  });\n}\n\ndeclare global {\n  interface ElementEventMap {\n    ['oscd-edit']: EditEvent;\n  }\n}\n\n/** EDIT HANDLING */\n\nfunction uniqueNSPrefix(element: Element, ns: string): string {\n  let i = 1;\n  const attributes = Array.from(element.attributes);\n  const hasSamePrefix = (attribute: Attr) =>\n    attribute.prefix === `ens${i}` && attribute.namespaceURI !== ns;\n  const nsOrNull = new Set([null, ns]);\n  const differentNamespace = (prefix: string) =>\n    !nsOrNull.has(element.lookupNamespaceURI(prefix));\n  while (differentNamespace(`ens${i}`) || attributes.find(hasSamePrefix))\n    i += 1;\n  return `ens${i}`;\n}\n\nfunction localAttributeName(attribute: string): string {\n  return attribute.includes(':') ? attribute.split(':', 2)[1] : attribute;\n}\n\nfunction handleInsert({\n  parent,\n  node,\n  reference,\n}: Insert): Insert | Remove | [] {\n  try {\n    const { parentNode, nextSibling } = node;\n    parent.insertBefore(node, reference);\n    if (parentNode)\n      return {\n        node,\n        parent: parentNode,\n        reference: nextSibling,\n      };\n    return { node };\n  } catch (e) {\n    // do nothing if insert doesn't work on these nodes\n    return [];\n  }\n}\n\nfunction handleUpdate({ element, attributes }: Update): Update {\n  const oldAttributes = { ...attributes };\n  Object.entries(attributes)\n    .reverse()\n    .forEach(([name, value]) => {\n      let oldAttribute: AttributeValue;\n      if (isNamespaced(value!))\n        oldAttribute = {\n          value: element.getAttributeNS(\n            value.namespaceURI,\n            localAttributeName(name)\n          ),\n          namespaceURI: value.namespaceURI,\n        };\n      else\n        oldAttribute = element.getAttributeNode(name)?.namespaceURI\n          ? {\n              value: element.getAttribute(name),\n              namespaceURI: element.getAttributeNode(name)!.namespaceURI!,\n            }\n          : element.getAttribute(name);\n      oldAttributes[name] = oldAttribute;\n    });\n  for (const entry of Object.entries(attributes)) {\n    try {\n      const [attribute, value] = entry as [string, AttributeValue];\n      if (isNamespaced(value)) {\n        if (value.value === null)\n          element.removeAttributeNS(\n            value.namespaceURI,\n            localAttributeName(attribute)\n          );\n        else element.setAttributeNS(value.namespaceURI, attribute, value.value);\n      } else if (value === null) element.removeAttribute(attribute);\n      else element.setAttribute(attribute, value);\n    } catch (e) {\n      // do nothing if update doesn't work on this attribute\n      delete oldAttributes[entry[0]];\n    }\n  }\n  return {\n    element,\n    attributes: oldAttributes,\n  };\n}\n\nfunction handleUpdateNS({\n  element,\n  attributes,\n  attributesNS,\n}: UpdateNS): UpdateNS {\n  const oldAttributes = { ...attributes };\n  const oldAttributesNS = { ...attributesNS };\n  Object.keys(attributes)\n    .reverse()\n    .forEach(name => {\n      oldAttributes[name] = element.getAttribute(name);\n    });\n  for (const entry of Object.entries(attributes)) {\n    try {\n      const [name, value] = entry as [string, Value];\n      if (value === null) element.removeAttribute(name);\n      else element.setAttribute(name, value);\n    } catch (e) {\n      // do nothing if update doesn't work on this attribute\n      delete oldAttributes[entry[0]];\n    }\n  }\n  Object.entries(attributesNS).forEach(([ns, attrs]) => {\n    Object.keys(attrs!)\n      .reverse()\n      .forEach(name => {\n        oldAttributesNS[ns] = {\n          ...oldAttributesNS[ns],\n          [name]: element.getAttributeNS(ns, name),\n        };\n      });\n  });\n  for (const nsEntry of Object.entries(attributesNS)) {\n    const [ns, attrs] = nsEntry as [string, Partial<Record<string, Value>>];\n    for (const entry of Object.entries(attrs)) {\n      try {\n        const [name, value] = entry as [string, Value];\n        if (value === null) element.removeAttributeNS(ns, name);\n        else {\n          let qualifiedName = name;\n          if (!qualifiedName.includes(':')) {\n            let prefix = element.lookupPrefix(ns);\n            if (!prefix) prefix = uniqueNSPrefix(element, ns);\n            qualifiedName = `${prefix}:${name}`;\n          }\n          element.setAttributeNS(ns, qualifiedName, value);\n        }\n      } catch (e) {\n        delete oldAttributesNS[entry[0]];\n      }\n    }\n  }\n  /*\n   */\n  return {\n    element,\n    attributes: oldAttributes,\n    attributesNS: oldAttributesNS,\n  };\n}\n\nfunction handleRemove({ node }: Remove): Insert | [] {\n  const { parentNode: parent, nextSibling: reference } = node;\n  node.parentNode?.removeChild(node);\n  if (parent)\n    return {\n      node,\n      parent,\n      reference,\n    };\n  return [];\n}\n\nexport function handleEdit(edit: Edit): Edit {\n  if (isInsert(edit)) return handleInsert(edit);\n  if (isUpdate(edit)) return handleUpdate(edit);\n  if (isUpdateNS(edit)) return handleUpdateNS(edit);\n  if (isRemove(edit)) return handleRemove(edit);\n  if (isComplex(edit)) return edit.map(handleEdit).reverse();\n  return [];\n}\n"],"names":[],"mappings":"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"}